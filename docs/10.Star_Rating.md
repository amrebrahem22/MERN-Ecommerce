# Star Rating

- the product model
```js
const mongoose = require('mongoose');
const { ObjectId } = mongoose.Schema;

const ProductSchema = mongoose.Schema({
    title: {
        type: String,
        required: true,
        trim: true,
        maxlength: 32,
        text: true
    },
    slug: {
        type: String,
        unique: true,
        lowercase: true,
        index: true
    },
    description: {
        type: String,
        required: true,
        maxlength: 2000,
        text: true
    },
    price: {
        type: Number,
        required: true,
        trim: true,
        maxlength: 32
    },
    category: {type: ObjectId, ref: 'Category'},
    subs: [
        {
            type: ObjectId,
            ref: 'Sub'
        }
    ],
    quantity: Number,
    sold: {
        type: Number,
        default: 0
    },
    images: {
        type: Array
    },
    shipping: {
        type: String,
        enum: ['Yes', 'No']
    },
    color: {
        type: String,
        enum: ['Black', 'Brown', 'Silver', 'White', 'Blue']
    },
    brand: {
        type: String,
        enum: ['Apple', 'Samsung', 'Microsoft', 'Lenovo', 'ASUS']
    },
    ratings: [
        {
            star: Number,
            postedBy: { type: ObjectId, ref: 'User' }
        }
    ]
}, {timestamps: true});

module.exports = mongoose.model('Product', ProductSchema);
```
- and in `routes/product.js` i created the route for leaving a comment
```js
const { create, listAll, remove, read, update, list, productsTotal, productStar } = require('../controllers/product');

router.post('/product/star/:productId', productStar);
```

- then in `controllers/product.js`
```js
exports.productStar = async (req, res) => {
    // get the product
    const product = await Product.findById(req.params.productId).exec()
    // get the user
    const user = await User.findOne({email: req.user.email}).exec();
    // get the star
    const { star } = req.body;

    // get the rate if exist
    const existingRate = product.ratings.find(elem => elem.postedBy.toString() === user._id.toString())

    // chech if the user left rate, if not push it to ratings array
    if (existingRate === undefined) {
        let rateAdded = await Product.findByIdAndUpdate(
            product._id,
            {
                $push: {
                    ratings: {
                        star, postedBy: user._id
                    }
                }
            },
            { new: true } 
        ).exec();

        console.log('rateAdded=>', rateAdded);
        res.json(rateAdded);

    } else {
        // if there's rate for this user get it and update it
        let rateUpdated = await Product.findOne(
            {
                ratings: {$elemMatch: existingRate}
            },
            {
                $set: { 'ratings.$.star': star }
            },
            { new: true }
        ).exec();
        
        console.log('rateUpdated=>', rateUpdated);
        res.json(rateUpdated);
    }
}
```

